.. post:: 
   :tags: Ubuntu, Linux, resonite, VR
   :category: "IT technology"
   :author: usaturn
   :location: Japan
   :language: ja

.. _about_operating_a_resonite_headless_server_on_gce_for_one_year:

================================================================================
Google Cloud Compute Engine で resonite ヘッドレスサーバを運用しての感想（駄文）
================================================================================

`(2枚目) Resonite Advent Calendar 2024 <https://adventar.org/calendars/10544>`__ 11日目の記事です


現状

自動運用している

トラブルについて
================

起動失敗
--------

2023/10/17 ～ より


2023/11/7 Steam/steamapps/common/Resonite/Headless/RuntimeData が存在しない
hamadori — 2024/01/02 22:59 今日の一号店の22:50頃？にクラッシュ sshで入れない




起動時トラブルの回数を、discord で確認する

- steamcmd のアップデートトラブル

  - steamcmd でアップデートできない事がある。何回かアップデートを繰り返すとうまくいく（原因不明）
  - 空き容量がない

    - キャッシュ削除: ${HOME}/.local/share/Steam/steamapps/common/Resonite/Headless/Cache/Cache
    - インスタンスの空き容量監視

- resonite ネットワークに繋がらなかった

  - 原因不明。同じタイミングで他の人も自宅ヘッドレスを起動しても入れなかった

- 指定したインスタンスタイプが、Google 側のリソース不足で起動できなかった

ヘッドレスサーバ_ クラッシュ
----------------------------

起動中に ヘッドレスサーバ_ のセッションがクラッシュしてユーザが追い出されたり、再度参加できなくなることがありました。
ほとんどの場合、原因がわかりません


その他
------

音声コーデックが Ogg Vorbis の不具合

  - 音声コーデックが Ogg Vorbis のファイルを BGM として流していた際、CPU 負荷 100% 張り付き状態で何度かクラッシュしたことがあります。
    その時は原因がわかりませんでしたが、他の方にヘッドアリ（つまり通常クライアント）でホストになってもらった時にクラッシュしないまでも CPU 負荷 100% になり
    調べてもらった所、原因が Ogg Vorbis を流しているプレーヤーだということがわかりました（mp3 や Opus は問題なし）

Linux 版は Windows 版より不安定な可能性アリ

  - あくまでも個人の肌感ですが、Linux 版は、起動時に特定のカレントディレクトリから実行すると起動失敗するとか、存在しないディレクトリを求められるとか、
    前出の原因不明のメモリリークが少なくない頻度であったという事象が記憶に残っています。

    開発側では Linux 版の試験工数を、あまり取ってないような気がしてなりません……（気のせいだとは思う）

意図しない長時間起動を防ぐ

    - GCE インスタンスは従量課金なので、起動しているのを忘れてしまった場合、意図しない料金が発生する可能性があります。
      shutdown ユニットを作ったり、全てのインスタンスに深夜 2 時頃には停止するスケジュールを組み込むと良いです。
      ここで詳細を述べるほどのことではありませんので、知りたい方がいらっしゃれば直接声を掛けてください

挑戦したいこと
==============

この先やってみようかなと考えていることです（全然やらないかも）


自分以外の人がインスタンスを制御する
------------------------------------

コミュニティ運用しているヘッドレスサーバについては、権限付与した人が任意の GCE インスタンスを起動／停止／再起動できるようにしたい。
また、Discord bot または Web アプリでヘッドレスサーバ貸出しができるといいんじゃないかと考えてますが、利用設計難しいですね。
無限に貸出は無理だし、申し込みした人の resonite ID の validate 方法もあるのかな？

便利 mod を入れる
-----------------

世の中には便利な mod があるらしいので入れてみたい。
なんも調べてませんが「これは入れておけ！」という mod があればどなたか教えてください！

Arm64 版を使ってみる
--------------------

`ばるさんが Arm64 で運用しているらしい <https://zenn.dev/hantabaru1014/articles/bbe64003d75141>`__ ので、自分も Google Cloud の Arm64 マシンタイプにトライしてみたいと考えています。
Google Cloud は Oracle Cloud のように無料で運用できるわけではありませんが、コストパフォーマンスは高そうです。
しかし、知見がない自分がゼロから始めるには結構手間かかりそう……

監視する
--------

現状では短時間運用（長くても 10 時間程度）しかしてない上に、自分かコミュニティの人が使っている為、落ちた時は人的手段で通知されるので、あまり必要性を感じていません。
が、Cloud Monitoring で監視して、なんらかの異常を検知しリアルタイムに異常状態の時の挙動を確認するような使い方であれば意味があるかも。
優先順位低めで検討してます。

最後に
======

`筆者 <https://bsky.app/profile/usaturn.net>`__ の 2024 年アドベントカレンダー 10 日分を書き終えました。
ヘッドレスサーバ_ に関する知見の 8 割程度は吐き出せたかと思ってます。
全てに目を通してくれている方がいらっしゃるとは思えませんが、少しでも読んで頂けたなら幸いです。
もし、よろしければフィードバックを頂けるとうれしいです

それでは、 resonite_ でお会いしましょう！

:resonite ID: usaturn
:VRChat ID: usaturn

PS: 実は 1 年前のアドベントカレンダーに書きたかった内容を温めすぎていました。量が多いので腰が重かったですし、いったん書き始めてからも、かなりの工数がかかりました……

.. include:: /contents/include_files/resonite_headless_link.txt

